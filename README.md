# ImageServer

## Описание
Сервер изображений, предназначенный для работы в паре с AIFrames - фоторамкой с генерацией изображений.
Фоторамка сделана на основе оригинального 
проекта ["Фоторамка с нейросетью"](https://github.com/AlexGyver/AiFrame ) Гайвера.
Аппаратная часть точно такая же. 
Прошивка - альтернативная [AiFrame ForImageServer](https://github.com/maxifly/AiFrameForImageServer).

В настоящий момент сервер генерирует изображения через YandexArt (Yandex взимает за это деньги)


## Принцип работы

### Запрос изображения
Со стороны рамки запрашивается, а сервер отдаёт изображение. Сервер поддерживает работу с внешними по отношению к нему провайдерами изображений.
Изображения, полученные от провайдера сохраняются на диске. Максимальное количество хранимых изображений задаётся параметром, 
при достижении порога часть самых старых изображений удаляется (сколько изображений необходимо оставить задаётся параметром)

При запросе изображения сервер обращается к внешнему провайдеру только если с прошлого обращения прошло не меньше заданного количества минут.
В противном случае сервер берёт случайное изображение из сохранённых на диске. Если сервер решает обратиться к провайдеру, 
то для начала он проверяет какие из провайдеров доступны. Может сложиться так, что провайдер не позволяет к нему обратиться (в силу своих настроек).
Если сервер не смог найти доступного провайдера, он обращается к внутреннему хранилищу.


Исключение составляют запросы, в которых явно указано обратиться к провайдеру.

На сервере указны параметры экрана рамки. Полученное со стороны внешнего провайдера изображение масштабируется под этот размер.

### Работа с промптами
Сервер хранит несколько промптов (10). При решении отправить запрос провайдеру из списка выбирается случайный промпт.
Новый промпт добавляется либо REST-запросом, либо редактированием конфига с сохранёнными промптами и перезапуском сервера.
При превышении количества промтов порогового значения - удаляется самый старый.

Так же есть возможность отправить на сервер запрос с текстом промпта. В этом случае генерируется изображение именно с этим промптом.
Промпт считается временным и в список промптов не сохраняется.

### Работа с провайдерами
Существует возможность дописать адаптеры к своим провайдерам. Адаптер должен поддерживать интерфейс ***ImageProvider*** (можно найти в коде)
Провайдер, к которому уйдёт запрос выбирается случайно.
В настоящий момент адаптер написан только к YandexArt. ()

### Период сна
В конфиге можно задать список периодов сна. Если текущее время попадает внутрь указанного периода, то сервер не отправляет запрос провайдеру.
Вместо этого, в зависимости от настроек он отправляет рамке либо изображение из локального хранилища, либо чёрный экран.

Исключение составляют запросы, в которых явно указано обратиться к провайдеру.


## Конфигурационные файлы
Все конфигурационные файлы должны находится в каталоге ```/data```

Примеры файлов можно найти в каталоге ```example```
### Конфигурация сервера
Файл  ```options.yml```

* ***log_level*** (строка) - уровень логирования<br/>DEBUG, INFO, WARNING, ERROR
* ***image_path*** (строка) - каталог, в котором хранятся изображения
* ***image_amount_min*** (число) - минимальное количество изображений в каталоге
* ***image_amount_max*** (число) - максимальное количество изображений в каталоге
* ***image_generate_threshold*** (число) - количество минут, которое должно пройти с предыдущего запроса к провайдеру,
     прежде чем сервер снова решит обратиться к какому-нибудь провайдеру вместо обращения к внутреннему хранилищу
* ***check_pending_cron*** (строка) - как часто сервер обращается к провайдеру, чтобы получить статус обрабатываемых на провайдере запросах<br/>В нотации  cron<br/>Значение по умолчанию * * * * *   (раз в минуту)
* ***scan_image_cron*** (строка) - как часто сервер проверяет количество сохранённых изображений. По умолчанию "0 0 * * *" (ежедневно в полночь)
* ***iframe_image_parameters*** - параметры рамки
   * ***image_weight*** (число) ширина изображения после масштабирования
   * ***image_height*** (число) - высота изображения после масштабирования
* ***prompts_amount*** (число) - максимальное количество промптов
* ***sleep_time*** - (список структур) периоды сна
    * ***time_range*** - период сна
      * ***start_time*** (строка) Начало периода "HH24:MI" (таймзона UTC)
      * ***end_time*** (строка) Конец периода "HH24:MI" (таймзона UTC)
    * ***black_image_mode*** режим "чёрное изображение" 
* ***providers*** (вложенная структура) - установки, специфичные для каждого провайдера 
    * ***ydArt*** (вложенная структура) - установки YandexArt
        * ***image_generate_threshold*** (число) - количество минут, которое должно пройти с предыдущего запроса к провайдеру <br/>
             Не позволит к нему обратиться если с предыдущего запроса прошло меньше времени
        * ***sleep_time*** - (список структур) периоды сна
            * ***time_range*** - период сна
                * ***start_time*** (строка) Начало периода "HH24:MI" (таймзона UTC)
                * ***end_time*** (строка) Конец периода "HH24:MI" (таймзона UTC)

### Список промтов
Файл ```prompts.yaml```
При первом запуске,при отсутствии, файл создаётся автоматически с единственным промптом "test"
(Не знаю, как будет у других, но у меня с ним получаются довольно интересные портреты)
Кроме того, создаётся файл ```prompts_example.yaml```. Для работы он не нужен, но его можно использовать в качестве примера.

Промпты бывают двух типов: **простой** и **шаблонный**. Простой - это просто строка. Шаблонный - строка с плейсхолдерами, которые при использовании промпта заменяются на случайное значение из списка.
Существует два списка значений - **глобальный** и **непосредственно в промпте**. Непосредственный перекрывает собой глобальный.
Один и тот же плейсхолдер может встречаться в строке несколько раз. При этом при раскрытии все позиции будут иметь разное значение.

Ключ параметра списка в YAML файле является так же и ключом плейсхолдера. 
Один и тот же плейсхолдер может встречаться в промпте несколько раз. Значение может состоять из нескольких слов

Например
```
prompts:
    - idx: 1
      prompt: '[[color]] робот-человек с крупными [[color]] глазами. Держит в руках [[weapon]]'
      placeholders:
        weapon:
        - автомат
        - бластер
    - idx: 2
      prompt: кукушка
global_placeholders:
    weapon:
      - камень
      - топор
    color:
      - кроваво красный
      - золотой
      - чёрный
      - розовый
```
У робота будет либо автомат, либо бластер, но не будет камня или топора. И цвет глаз робота может отличаться от цвета тела.

При старте сервер производит валидацию всех шаблонных промптов. Результат валидации выводится в лог.

Структура файла:

* ***prompts*** (список) - список промптов
    * ***idx*** (число) -  от 1 до N (***задаётся параметром***). Должно быть уникальным. Разрывы не допускаются. Промпт с минимальным индексом считается самым старым.
    * ***prompt*** (строка) - промпт
    * ***negative*** (строка) - егативная часть промта. (необязательный)
    * ***global_placeholders*** - список плейсхолдеров промпта (необязательный)
      * placeholder1_key:
         - value 1
         - value 2
      * placeholder2_key:
          - value 1
          - value 2* 
* ***global_placeholders*** - глобальный список плейсхолдеров (необязательный)
    * placeholder1_key:
        - value 1
        - value 2
    * placeholder2_key:
        - value 1
        - value 2

### Настройки YandexArt
Файл ```ydart-options.json```

***Внимание!!*** Для использование YandexArt Вам придётся настроить оформить подписку на YandexCloud.
В результате этот файл будет содержать данные, дающие доступ к платным методам. 
Будте осторожны, не выкладывайте их в общий доступ.

| Параметр   | Тип        | Назначение             |
|------------|------------|------------------------|
| folder_id  | строка     | идентификатор каталога |
| api_key | строка | Код ключа приложения   |

## Установка и запуск

***ВАЖНОЕ ЗАМЕЧАНИЕ***
> Для непосвященного выглядит сложновато, но на самом деле это не страшно
> 
> Не бойтесь и у вас все получится

***ВТОРОЕ ВАЖНОЕ ЗАМЕЧАНИЕ***
> Да, я знаю, что это не единственный способ. Можно и по другому, Но он точно рабочий и прост для понимания



Сервер предполагается запускать в docker и управлять им с помощью docker-compose
(Возможно, такое можно организовать в Windows, но я проверял работу на Linux)

1. Установите docker и docker-compose (самый сложный пункт)

   я проверял на версиях:
```
   $ docker --version
   Docker version 28.5.0, build 887030f
   $ docker-compose  --version
   Docker Compose version v2.40.1
```
2. Выберите или создайте три каталога (не важно где) где вы будете хранить
* конфигурацию
* изображения
* логи
3. Перейдите в корневой каталог проекта
4. Измените файл ```docker-compose.yml```
Замените пути ДО двоеточия на свои
```
      - /home/maxim/ImageServerFiles/data:/data
      - /home/maxim/ImageServerFiles/images:/images
      - /home/maxim/ImageServerFiles/log:/log
```
5. При необходимости измените порт, на который будет обращаться рамка, изменив число ПОСЛЕ двоеточия
```
   ports:
    - "8099:8099"
```
6. Дайте команду на сборку и запуск образа
```docker-compose up -d```

## Установка следующей версии
Допустим (хаха), будет следующая версия сервера.
Вот что надо сделать чтобы залить изменения.
1. Перейти в корень проекта.
2. Последовательно выполнить следующие команды
```
# Остановить контейнеры
docker-compose down

# Пересобрать образы и запустить
docker-compose up --build -d
```

## Остановка и запуск контейнера
Контейнер настроен таким образом, что после перезапуска компьютера он сразу начнёт работу.
Но если вы хотите вручную остановить его а потом снова запустить его, то выполните команды (из корня проекта)
```
# Остановить
docker-compose stop
# Запустить
docker-compose start
```

## Дополнительная информация

### Метрики
Метриками покрыты:
* все виды запросов от рамки к серверу
* запросы от сервера к YandexArt на генерацию изображения

При рестарте сервера метрики обнуляются.
Раз в час метрики скидываются в лог. Кроме того, основные метрики можно посмотреть на странице

``` 
http://<IP сервера>>:8099/
```

Наибольший интерес представляют:
* Yandex art success
* Yandex art success rate (req per hour)
по которым приблизительно можно оценить сколько придётся заплатить за генерацию изображений.

Метрика ***Total Requests*** показывает сколько всего запросов сервер обработал. Имеется ввиду не изображений, 
а именно запросов. На одно изображение рамка отправит минимум два запроса: запрос на генерацию и запрос проверки готовности. При этом, если к моменту второго запроса изображение ещё не готово, то через некоторое время рамка отправит запрос проверки готовности повторно.


Метрика ***Images Sent*** показывает сколько изображений отправил сервер на рамку.



     
### Поддерживаемые REST запросы
    
#### POST /operation/start
Старт задания

| Тело                                                            | Описание                                                                                |
|-----------------------------------------------------------------|-----------------------------------------------------------------------------------------|
| {"type": "auto"}                                                | Сервер сам решает откуда взять изображение                                              |
| {"type": "old"}                                                 | Сервер вернёт картинку из хранилища                                                     |
| {"type": "ydart"}                                               | Сервер вернёт картинку из провайдера                                                    |
| {"type": "ydart", <br/>"prompt":"blabla", <br/>"negative":"blablablabla"} | Сервер вернёт картинку из провайдера передав ему промпт<br/>"negative" - необязательный |

Ответ - тело с идентификатором операции

#### GET /operation/status/{operationId}
Получить статус операции

Ответ - тело со статусом

#### GET /operation/result/{operationId}
Получить и статус и результат (если он есть) одновременно

Ответ - тело со статусом, тело со статусом и с изображением. Тело с изображением передаётся чанками.

#### POST /prompt/add
Сохранить новый промпт

Тело запроса:
```
{"prompt":"blabla", "negative":"blablablabla"}
```
"negative" - необязательный

### YandexArt
#### Как это всё работает? 

Через API YandexCloud. Вам нужно будет сделать примерно следующее

1. зарегистрироваться на YandexCloud.
2. В консоли управления YandexCloud создать каталог
3. Созданному каталогу выдать роль, дающую право на генерацию изображения (идентификатор каталога запомнить)
4. Создать сервисный аккаунт
5. В сервисном аккаунте создать ApiKey с аналогичной ролью (код ключа запомнить. **ВНИМАНИЕ!** Консодь после генерации показывает его только один раз)

Читайте доку, она у них довольно подробная. 
Если Вы новый  пользователь, то Вам дадут грант (немножко денежек) на попробовать. 
Читайте ДОКУ ВНИМАТЕЛЬНО!!! У получения гранта есть допусловия (что-то там заранее привязать карту)
иначе вы получите 0 и второй попытки не будет.

#### Негативный промпт
В настоящий момент у яндекса нет толковой поддержки негативных промптов. 
В доке анонсирована, но написано, что не поддерживается. Приходится колхозить (добавлять к позитивному ```Игнорировать следующее: блаблабла``)
Работает эта подпорка так себе.

# БОНУС
Думаю, любому хотелось бы сразу стартануть с неким набором картинок, а не ждать пока наполнится хранилище.
Поэтому я подготовил небольшой архив. Перед стартом закинте его в каталог, где у вас будут хранится изображения

[КАРТИНКИ](https://disk.yandex.ru/d/mgR1vbx2Lob32A)





