# ImageServer

## Описание
Сервер изображений, предназначенный для работы в паре с AIFrames - фоторамкой с генерацией изображений.
Фоторамка сделана на основе оригинального 
проекта ["Фоторамка с нейросетью"](https://github.com/AlexGyver/AiFrame ) Гайвера.
Аппаратная часть точно такая же. 
Прошивка - альтернативная [AiFrame ForImageServer](https://github.com/maxifly/AiFrameForImageServer).

В настоящий момент сервер генерирует изображения через YandexArt (Yandex взимает за это деньги)


## Принцип работы

### Запрос изображения
Со стороны рамки запрашивается, а сервер отдаёт изображение. Сервер поддерживает работу с внешними по отношению к нему провайдерами изображений.
Изображения, полученные от провайдера сохраняются на диске. Максимальное количество хранимых изображений задаётся параметром, 
при достижении порога часть самых старых изображений удаляется (сколько изображений необходимо оставить задаётся параметром)

При запросе изображения сервер обращается к внешнему провайдеру только если с прошлого обращения прошло не меньше заданного количества минут.
В противном случае сервер берёт случайное изображение из сохранённых на диске.

Исключение составляют запросы, в которых явно указано обратиься к провайдеру.

На сервере указны параметры экрана рамки. Полученное со стороны внешнего провайдера изображение масштабируется под этот размер.

### Работа с промптами
Сервер хранит несколько промптов (10). При решении отправить запрос провайдеру из списка выбирается случайный промпт.
Новый промпт добавляется либо REST-запросом, либо редактированием конфига с сохранёнными промптами и перезапуском сервера.
При превышении количества промтов порогового значения - удаляется самый старый.

Так же есть возможность отправить на сервер запрос с текстом промпта. В этом случае генерируется изображение именно с этим промптом.
Промпт считается временным и в список промптов не сохраняется.

### Работа с провайдерами
Существует возможность дописать адаптеры к своим провайдерам. Адаптер должен поддерживать интерфейс ***ImageProvider*** (можно найти в коде)
Провайдер, к которому уйдёт запрос выбирается случайно.
В настоящий момент адаптер написан только к YandexArt. ()

## Конфигурационные файлы
TODO

Все конфигурационные файлы должны находится в каталоге ```/data```
### Конфигурация сервера
Файл  ```options.yml```

| Параметр | Тип    | Назначение                                                                                                                                                                     |
|----------|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|log_level| строка | Уровень логирования<br/>DEBUG, INFO, WARNING, ERROR                                                                                                                            |
|image_path| строка | каталог, в котором хранятся изображения                                                                                                                                        |
|image_amount_min| число  | минимальное количество изображений в каталоге                                                                                                                                  |
|image_amount_max| число  | максимальное количество изображений в каталоге                                                                                                                                 |
|image_generate_threshold| число  | Количество минут, которое должно пройти с предыдущего запроса к провайдеру,<br/> прежде чем сервер снова обратится к провайдеру вместо обращения к внутреннему хранилищу       |
|check_pending_cron| строка | Как часто сервер обращается к провайдеру, чтобы получить статус обрабатываемых на провайдере запросах<br/>В нотации  cron<br/>Значение по умолчанию * * * * *   (раз в минуту) |
|scan_image_cron| строка | Как часто сервер проверяет количество сохранённых изображений                                                                                                                  |
|image_weight| число  | Ширина изображения после масштабирования                                                                                                                                 |
|image_height| число  | Высота изображения после масштабирования                                                                                                                                                            |

### Список промтов
Файл ```prompts.json```
При первом запуске,при отсутсвии, файл создаётся автоматически с единственным промптом "test"

| Параметр | Тип      | Назначение                                                                                                                                                                       |
|----------|----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|prompts| список   | список промптов                                                                                                                                                                  |

#### Параметры промпта
| Параметр | Тип      | Назначение                                                                                                                                                                       |
|----------|----------|--------------------------------------------------------------------------------------------------------------------------|
|idx| число    | от 1 до 10. Должно быть уникальным. Разрывы не допускаются. Промпт с минимальным индексом считается самым старым.                                                                |
|prompt| строка   | промт                                                                                                                                                                            |
|negative| строка | Негативная часть промта. (необязательный)                                                                                                                                        |

### Настройки YandexArt
Файл ```ydart-options.json```

***Внимание!!*** Для использование YandexArt Вам придётся настроить оформить подписку на YandexCloud
В результате этот файл будет содержать данные, дающие доступ к платным методам. 
Будте осторожны, не выкладывайте их в общий доступ.

| Параметр   | Тип        | Назначение             |
|------------|------------|------------------------|
| folder_id  | строка     | идентификатор каталога |
| api_key | строка | Код ключа приложения   |

## Установка и запуск
TODO

## Поддерживаемые запросы
TODO

## Дополнительная информация
TODO
### YandexArt


