# ImageServer

## Описание
Сервер изображений, предназначенный для работы в паре с AIFrames - фоторамкой с генерацией изображений.
Фоторамка сделана на основе оригинального 
проекта ["Фоторамка с нейросетью"](https://github.com/AlexGyver/AiFrame ) Гайвера.
Аппаратная часть точно такая же. 
Прошивка - альтернативная [AiFrame ForImageServer](https://github.com/maxifly/AiFrameForImageServer).

В настоящий момент сервер генерирует изображения через YandexArt (Yandex взимает за это деньги)


## Принцип работы

### Запрос изображения
Со стороны рамки запрашивается, а сервер отдаёт изображение. Сервер поддерживает работу с внешними по отношению к нему провайдерами изображений.
Изображения, полученные от провайдера сохраняются на диске. Максимальное количество хранимых изображений задаётся параметром, 
при достижении порога часть самых старых изображений удаляется (сколько изображений необходимо оставить задаётся параметром)

При запросе изображения сервер обращается к внешнему провайдеру только если с прошлого обращения прошло не меньше заданного количества минут.
В противном случае сервер берёт случайное изображение из сохранённых на диске.

Исключение составляют запросы, в которых явно указано обратиься к провайдеру.

На сервере указны параметры экрана рамки. Полученное со стороны внешнего провайдера изображение масштабируется под этот размер.

### Работа с промптами
Сервер хранит несколько промптов (10). При решении отправить запрос провайдеру из списка выбирается случайный промпт.
Новый промпт добавляется либо REST-запросом, либо редактированием конфига с сохранёнными промптами и перезапуском сервера.
При превышении количества промтов порогового значения - удаляется самый старый.

Так же есть возможность отправить на сервер запрос с текстом промпта. В этом случае генерируется изображение именно с этим промптом.
Промпт считается временным и в список промптов не сохраняется.

### Работа с провайдерами
Существует возможность дописать адаптеры к своим провайдерам. Адаптер должен поддерживать интерфейс ***ImageProvider*** (можно найти в коде)
Провайдер, к которому уйдёт запрос выбирается случайно.
В настоящий момент адаптер написан только к YandexArt. ()

## Конфигурационные файлы
Все конфигурационные файлы должны находится в каталоге ```/data```
### Конфигурация сервера
Файл  ```options.yml```

| Параметр | Тип    | Назначение                                                                                                                                                                     |
|----------|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|log_level| строка | Уровень логирования<br/>DEBUG, INFO, WARNING, ERROR                                                                                                                            |
|image_path| строка | каталог, в котором хранятся изображения                                                                                                                                        |
|image_amount_min| число  | минимальное количество изображений в каталоге                                                                                                                                  |
|image_amount_max| число  | максимальное количество изображений в каталоге                                                                                                                                 |
|image_generate_threshold| число  | Количество минут, которое должно пройти с предыдущего запроса к провайдеру,<br/> прежде чем сервер снова обратится к провайдеру вместо обращения к внутреннему хранилищу       |
|check_pending_cron| строка | Как часто сервер обращается к провайдеру, чтобы получить статус обрабатываемых на провайдере запросах<br/>В нотации  cron<br/>Значение по умолчанию * * * * *   (раз в минуту) |
|scan_image_cron| строка | Как часто сервер проверяет количество сохранённых изображений. По умолчанию "0 0 * * *" (ежедневно в полночь)                                                                  |
|image_weight| число  | Ширина изображения после масштабирования                                                                                                                                       |
|image_height| число  | Высота изображения после масштабирования                                                                                                                                       |

### Список промтов
Файл ```prompts.json```
При первом запуске,при отсутсвии, файл создаётся автоматически с единственным промптом "test"
(Не знаю, как будет у других, но у меня с ним получаются довольно интересные портреты)

| Параметр | Тип      | Назначение                                                                                                                                                                       |
|----------|----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|prompts| список   | список промптов                                                                                                                                                                  |

#### Параметры промпта
| Параметр | Тип      | Назначение                                                                                                                                                                       |
|----------|----------|--------------------------------------------------------------------------------------------------------------------------|
|idx| число    | от 1 до 10. Должно быть уникальным. Разрывы не допускаются. Промпт с минимальным индексом считается самым старым.                                                                |
|prompt| строка   | промт                                                                                                                                                                            |
|negative| строка | Негативная часть промта. (необязательный)                                                                                                                                        |

### Настройки YandexArt
Файл ```ydart-options.json```

***Внимание!!*** Для использование YandexArt Вам придётся настроить оформить подписку на YandexCloud.
В результате этот файл будет содержать данные, дающие доступ к платным методам. 
Будте осторожны, не выкладывайте их в общий доступ.

| Параметр   | Тип        | Назначение             |
|------------|------------|------------------------|
| folder_id  | строка     | идентификатор каталога |
| api_key | строка | Код ключа приложения   |

## Установка и запуск

***ВАЖНОЕ ЗАМЕЧАНИЕ***
> Для непосвященного выглядит сложновато, но на самом деле это не страшно
> 
> Не бойтесь и у вас все получится

***ВТОРОЕ ВАЖНОЕ ЗАМЕЧАНИЕ***
> Да, я знаю, что это не единственный способ. Можно и по другому, Но он точно рабочий и прост для понимания



Сервер предполагается запускать в docker и управлять им с помощью docker-compose
(Возможно, такое можно организовать в Windows, но я проверял работу на Linux)

1. Установите docker и docker-compose (самый сложный пункт)

   я проверял на версиях:
```
   $ docker --version
   Docker version 28.5.0, build 887030f
   $ docker-compose  --version
   Docker Compose version v2.40.1
```
2. Выберите или создайте три каталога (не важно где) где вы будете хранить
* конфигурацию
* изображения
* логи
3. Перейдите в корневой каталог проекта
4. Измените файл ```docker-compose.yml```
Замените пути ДО двоеточия на свои
```
      - /home/maxim/ImageServerFiles/data:/data
      - /home/maxim/ImageServerFiles/images:/images
      - /home/maxim/ImageServerFiles/log:/log
```
5. При необходимости измените порт, на который будет обращаться рамка, изменив число ПОСЛЕ двоеточия
```
   ports:
    - "8099:8099"
```
6. Дайте команду на сборку и запуск образа
```docker-compose up -d```

## Установка следующей версии
Допустим (хаха), будет следующая версия сервера.
Вот что надо сделать чтобы залить изменения.
1. Перейти в корень проекта.
2. Последовательно выполнить следующие команды
```
# Остановить контейнеры
docker-compose down

# Пересобрать образы и запустить
docker-compose up --build -d
```

## Остановка и запуск контейнера
Контейнер настроен таким образом, что после перезапуска компьютера он сразу начнёт работу.
Но если вы хотите вручную остановить его а потом снова запустить его, то выполните команды (из корня проекта)
```
# Остановить
docker-compose stop
# Запустить
docker-compose start
```

## Дополнительная информация
### Поддерживаемые REST запросы
    
#### POST /operation/start
Старт задания

| Тело                                                            | Описание                                                                                |
|-----------------------------------------------------------------|-----------------------------------------------------------------------------------------|
| {"type": "auto"}                                                | Сервер сам решает откуда взять изображение                                              |
| {"type": "old"}                                                 | Сервер вернёт картинку из хранилища                                                     |
| {"type": "ydart"}                                               | Сервер вернёт картинку из провайдера                                                    |
| {"type": "ydart", <br/>"prompt":"blabla", <br/>"negative":"blablablabla"} | Сервер вернёт картинку из провайдера передав ему промпт<br/>"negative" - необязательный |

Ответ - тело с идентификатором операции

#### GET /operation/status/{operationId}
Получить статус операции

Ответ - тело со статусом

#### GET /operation/result/{operationId}
Получить и статус и результат (если он есть) одновременно

Ответ - тело со статусом, тело со статусом и с изображением. Тело с изображением передаётся чанками.

#### POST /prompt/add
Сохранить новый промпт

Тело запроса:
```
{"prompt":"blabla", "negative":"blablablabla"}
```
"negative" - необязательный

### YandexArt
#### Как это всё работает? 

Через API YandexCloud. Вам нужно будет сделать примерно следующее

1. зарегистрироваться на YandexCloud.
2. В консоли управления YandexCloud создать каталог
3. Созданному каталогу выдать роль, дающую право на генерацию изображения (идентификатор каталога запомнить)
4. Создать сервисный аккаунт
5. В сервисном аккаунте создать ApiKey с аналогичной ролью (код ключа запомнить. **ВНИМАНИЕ!** Консодь после генерации показывает его только один раз)

Читайте доку, она у них довольно подробная. 
Если Вы новый  пользователь, то Вам дадут грант (немножко денежек) на попробовать. 
Читайте ДОКУ ВНИМАТЕЛЬНО!!! У получения гранта есть допусловия (что-то там заранее привязать карту)
иначе вы получите 0 и второй попытки не будет.

#### Негативный промпт
В настоящий момент у яндекса нет толковой поддержки негативных промптов. 
В доке анонсирована, но написано, что не поддерживается. Приходится колхозить (добавлять к позитивному ```Игнорировать следующее: блаблабла``)
Работает эта подпорка так себе.

# БОНУС
Думаю, любому хотелось бы сразу стартануть с неким набором картинок, а не ждать пока наполнится хранилище.
Поэтому я подготовил небольшой архив. Перед стартом закинте его в каталог, где у вас будут хранится изображения

[КАРТИНКИ](https://disk.yandex.ru/d/mgR1vbx2Lob32A)





